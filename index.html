<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="theme-color" content="#EF4444">
  <title>Bonus Driving School — Modern</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/classic.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr"></script>
  <style>
    body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial; margin:0}
    .glass { background: rgba(255,255,255,0.6); backdrop-filter: blur(6px); }
    .fade-in { animation: fadeIn 400ms ease both; }
    @keyframes fadeIn{ from{opacity:0; transform: translateY(-8px)} to{opacity:1; transform:none} }
    .card { border-radius:16px; box-shadow: 0 10px 30px rgba(2,6,23,0.12); }
    .btn { transition: transform .14s ease, box-shadow .14s ease; }
    .btn:hover{ transform: translateY(-2px); box-shadow: 0 8px 20px rgba(2,6,23,0.08); }
  </style>
</head>
<body>
<div id="app"></div>
<script>
// firebase (same config)
const firebaseConfig = {
  apiKey: "AIzaSyD4En5Xe4HKjUd0LYrsmHHeV2ZjFyjxnBU",
  authDomain: "bonus-driving-school-aabd2.firebaseapp.com",
  projectId: "bonus-driving-school-aabd2",
  storageBucket: "bonus-driving-school-aabd2.firebasestorage.app",
  messagingSenderId: "72558421307",
  appId: "1:72558421307:web:e9d3450e78e8d4e13d431e",
  measurementId: "G-WT9KQ340DG"
};
let db=null, storage=null, firebaseInitialized=false;
try{ firebase.initializeApp(firebaseConfig); db=firebase.firestore(); storage=firebase.storage(); firebaseInitialized=true;}catch(e){console.error(e)}

// state (similar to classic)
const state = { page:'home', selectedLicense:null, idNumber:'', currentTest:[], currentQuestion:0, answers:[], testResults:null, isAdmin:false, adminPage:'questions', editingQuestion:null, selectedLicenseType:'code1', config:{ appName:'Bonus Driving School', logo:null, primaryColor:'#EF4444', secondaryColor:'#000000', backgroundColor:'#FFFFFF' }, questions:null, testHistory:{} };

function generateDefaultQuestions(){ return { code1:[{id:1,question:'What is the speed limit in urban area?',options:['60','80','100','120'],correct:0,image:null}], code2:[], code3:[] }; }
function defaultControlQuestions(){ return [{id:9001,question:'[CONTROL] What is the speed limit in urban areas?',options:['60 km/h','80 km/h','100 km/h','120 km/h'],correct:0,image:null}]; }

async function loadState(){ try{ const saved = localStorage.getItem('drivingSchoolQuestions'); if(saved) state.questions = JSON.parse(saved); const cfgSaved = localStorage.getItem('drivingSchoolConfig'); if(cfgSaved) state.config = JSON.parse(cfgSaved); if(firebaseInitialized){ const qDoc = await db.collection('data').doc('questions').get(); if(qDoc.exists) state.questions = qDoc.data(); else state.questions = {...generateDefaultQuestions(), control: defaultControlQuestions()}; const cfgDoc = await db.collection('config').doc('appConfig').get(); if(cfgDoc.exists) state.config = cfgDoc.data(); localStorage.setItem('drivingSchoolQuestions', JSON.stringify(state.questions)); localStorage.setItem('drivingSchoolConfig', JSON.stringify(state.config)); db.collection('data').doc('questions').onSnapshot(doc=>{ if(doc.exists){ state.questions = doc.data(); localStorage.setItem('drivingSchoolQuestions', JSON.stringify(state.questions)); if(state.page==='admin') render(); } }); db.collection('config').doc('appConfig').onSnapshot(doc=>{ if(doc.exists){ state.config = doc.data(); localStorage.setItem('drivingSchoolConfig', JSON.stringify(state.config)); render(); } }); } else { if(!state.questions) state.questions = {...generateDefaultQuestions(), control: defaultControlQuestions()}; } }catch(e){ console.error(e); if(!state.questions) state.questions = {...generateDefaultQuestions(), control: defaultControlQuestions()}; } render(); }

async function saveState(){ try{ localStorage.setItem('drivingSchoolQuestions', JSON.stringify(state.questions)); localStorage.setItem('drivingSchoolConfig', JSON.stringify(state.config)); if(firebaseInitialized){ const questionsForFirestore = {}; for(const k in state.questions){ questionsForFirestore[k] = state.questions[k].map(q=>{ if(q.image && q.image.startsWith('data:image')) return {...q, image:`storage:questions/${k}/${q.id}`}; return q; }); } await db.collection('data').doc('questions').set(questionsForFirestore); await db.collection('config').doc('appConfig').set(state.config); } }catch(e){console.error(e);} }

function uploadImageBase64(licenseType, questionId, base64){ if(!firebaseInitialized) return null; return storage.ref(`questions/${licenseType}/${questionId}`).putString(base64.split(',')[1], 'base64').then(()=> storage.ref(`questions/${licenseType}/${questionId}`).getDownloadURL()).catch(e=>{console.error(e);return null}); }

function goHome(){ state.page='home'; state.isAdmin=false; render(); }
function selectLicense(l){ state.selectedLicense=l; state.page='id-input'; render(); }
function showAdminLogin(){ state.page='admin-login'; render(); }
function tryAdminLogin(pw){ if(pw==='admin123'){ state.isAdmin=true; state.page='admin'; render(); } else { alert('Incorrect password'); } }

function startTest(){ if(state.idNumber.trim().length<5){ alert('Please enter a valid ID number'); return; } const controlQuestions = state.questions.control || defaultControlQuestions(); const all = state.questions[state.selectedLicense] || []; const shuffled = all.sort(()=>Math.random()-0.5).slice(0,114); state.currentTest=[...shuffled, ...controlQuestions]; state.answers=new Array(state.currentTest.length).fill(null); state.currentQuestion=0; state.page='test'; render(); }

function submitAnswer(i){ state.answers[state.currentQuestion]=i; if(state.currentQuestion < state.currentTest.length-1){ state.currentQuestion++; render(); } else finishTest(); }

function finishTest(){ const results = state.currentTest.map((q,i)=>({question:q.question,userAnswer:state.answers[i],correctAnswer:q.correct,isCorrect:state.answers[i]===q.correct,options:q.options,image:q.image})); const score = results.filter(r=>r.isCorrect).length; const percentage = ((score/results.length)*100).toFixed(1); const record={date:new Date().toISOString(),licenseType:state.selectedLicense,score,total:results.length,percentage,results}; if(!state.testHistory[state.idNumber]) state.testHistory[state.idNumber]=[]; state.testHistory[state.idNumber].push(record); localStorage.setItem('drivingSchoolHistory', JSON.stringify(state.testHistory)); state.testResults=record; state.page='results'; render(); }

// Admin CRUD simplified for brevity (same behavior as classic)
function addQuestion(){ const newId=Date.now(); state.editingQuestion={id:newId,question:'',options:['','','',''],correct:0,image:null}; render(); }
function saveQuestion(){ const q=state.editingQuestion; if(!q.question.trim()){ alert('Question text required'); return; } const arr = state.questions[state.selectedLicenseType] = state.questions[state.selectedLicenseType] || []; const idx = arr.findIndex(x=>x.id===q.id); if(idx>=0) arr[idx]=q; else arr.push(q); state.editingQuestion=null; saveState(); render(); }
function handleImageForEditing(e){ const file=e.target.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=async ev=>{ state.editingQuestion.image=ev.target.result; if(firebaseInitialized){ try{ const url = await uploadImageBase64(state.selectedLicenseType, state.editingQuestion.id, state.editingQuestion.image); state.editingQuestion.imageUrl = url; }catch(e){console.error(e);} } render(); }; reader.readAsDataURL(file); }
function deleteQuestion(id){ if(confirm('Delete?')){ state.questions[state.selectedLicenseType]=state.questions[state.selectedLicenseType].filter(q=>q.id!==id); saveState(); render(); } }

// Pickr init
let pickrPrimary, pickrSecondary, pickrBackground;
function initPickrs(){ if(window._pickrInit) return; window._pickrInit=true; const P=window.Pickr; pickrPrimary = P.create({ el:'.pickr-primary', theme:'classic', default: state.config.primaryColor, components:{preview:true, hue:true, interaction:{hex:true,input:true,save:true}} }); pickrSecondary = P.create({ el:'.pickr-secondary', theme:'classic', default: state.config.secondaryColor, components:{preview:true, hue:true, interaction:{hex:true,input:true,save:true}} }); pickrBackground = P.create({ el:'.pickr-background', theme:'classic', default: state.config.backgroundColor, components:{preview:true, hue:true, interaction:{hex:true,input:true,save:true}} }); pickrPrimary.on('save',c=>{ state.config.primaryColor=c.toHEXA().toString(); pickrPrimary.hide(); saveState(); render(); }); pickrSecondary.on('save',c=>{ state.config.secondaryColor=c.toHEXA().toString(); pickrSecondary.hide(); saveState(); render(); }); pickrBackground.on('save',c=>{ state.config.backgroundColor=c.toHEXA().toString(); pickrBackground.hide(); saveState(); render(); }); }

// Render Modern app (kept concise)
function render(){
  const app=document.getElementById('app');
  document.body.style.background = state.config.backgroundColor || '#fff';
  if(state.page==='home'){
    app.innerHTML = `
    <div class="min-h-screen flex flex-col">
      <header class="p-6" style="background:${state.config.primaryColor}"><h1 class="text-3xl font-bold text-white text-center">${state.config.appName}</h1></header>
      <main class="flex-1 p-6 flex items-center justify-center">
        <div class="grid gap-4 w-full max-w-3xl">
          <div class="grid grid-cols-3 gap-4">
            <button onclick="selectLicense('code1')" class="col-span-1 p-6 rounded-lg card btn text-white" style="background:${state.config.primaryColor}">Code 1</button>
            <button onclick="selectLicense('code2')" class="col-span-1 p-6 rounded-lg card btn text-white" style="background:${state.config.primaryColor}">Code 2</button>
            <button onclick="selectLicense('code3')" class="col-span-1 p-6 rounded-lg card btn text-white" style="background:${state.config.primaryColor}">Code 3</button>
          </div>
          <div class="text-center"><button onclick="showAdminLogin()" class="px-6 py-3 rounded btn" style="background:${state.config.secondaryColor}; color:white">Admin Access</button></div>
        </div>
      </main>
    </div>`;
  } else if(state.page==='admin-login'){
    app.innerHTML = `
      <div class="min-h-screen flex items-center justify-center" style="background: linear-gradient(180deg, rgba(0,0,0,0.12), rgba(0,0,0,0.06)); backdrop-filter: blur(4px);">
        <div class="card fade-in p-8 w-full max-w-md glass">
          ${state.config.logo?`<img src="${state.config.logo}" class="mx-auto h-16 mb-4">`:''}
          <h2 class="text-2xl font-bold mb-4 text-center">Admin Panel</h2>
          <input id="adminPw" type="password" placeholder="Password" class="w-full p-3 rounded mb-4 border" />
          <div class="flex gap-2"><button onclick="tryAdminLogin(document.getElementById('adminPw').value)" class="flex-1 p-3 rounded text-white" style="background:${state.config.primaryColor}">Unlock</button><button onclick="goHome()" class="p-3 rounded border">Cancel</button></div>
        </div>
      </div>`;
  } else if(state.page==='admin' && state.isAdmin){
    renderAdminModern();
  } else {
    app.innerHTML = `<div class="p-6">Page: ${state.page}</div>`;
  }
  setTimeout(()=>initPickrs(),120);
}

function renderAdminModern(){
  const app=document.getElementById('app');
  const tabs = `<div class="flex gap-2 mb-6"><button onclick="state.adminPage='questions'; renderAdminModern()" class="px-4 py-2 rounded" style="background:${state.adminPage==='questions'?state.config.primaryColor:'#E5E7EB'}; color:${state.adminPage==='questions'?'white':state.config.secondaryColor}">Questions</button><button onclick="state.adminPage='settings'; renderAdminModern()" class="px-4 py-2 rounded" style="background:${state.adminPage==='settings'?state.config.primaryColor:'#E5E7EB'}; color:${state.adminPage==='settings'?'white':state.config.secondaryColor}">Settings</button></div>`;
  let content='';
  if(state.adminPage==='questions'){
    content = `<div class="bg-white p-4 rounded card"><div class="flex gap-2 mb-4">${['code1','code2','code3','control'].map(t=>`<button onclick="state.selectedLicenseType='${t}'; renderAdminModern()" class="px-3 py-2 rounded" style="background:${state.selectedLicenseType===t?state.config.primaryColor:'#F3F4F6'}; color:${state.selectedLicenseType===t?'white':state.config.secondaryColor}">${t.toUpperCase()}</button>`).join('')}</div><button onclick="addQuestion()" class="mb-4 px-4 py-2 rounded text-white" style="background:${state.config.primaryColor}">+ Add</button><div>${(state.questions[state.selectedLicenseType]||[]).map(q=>`<div class="flex justify-between p-3 border-b"><div>${q.question}</div><div><button onclick="state.editingQuestion=state.questions['${state.selectedLicenseType}'].find(x=>x.id===${'q.id'}); renderAdminModern()" class="mr-2">Edit</button><button onclick="deleteQuestion(${ 'q.id' })">Del</button></div></div>`).join('')}</div></div>`;
  } else if(state.adminPage==='settings'){
    content = `<div class="bg-white p-4 rounded card"><h3 class="font-bold mb-4">Appearance</h3><div class="mb-4"><label class="block">Primary Color</label><div class="pickr-primary inline-block"></div></div><div class="mb-4"><label class="block">Secondary Color</label><div class="pickr-secondary inline-block"></div></div><div class="mb-4"><label class="block">Background Color</label><div class="pickr-background inline-block"></div></div></div>`;
  }
  app.innerHTML = `<div class="min-h-screen" style="background:${state.config.backgroundColor}"><div class="p-6" style="background:${state.config.primaryColor}"><button onclick="goHome()" class="text-white">← Back</button></div><div class="p-6">${tabs}${content}</div></div>`;
}

loadState();
</script>
</body>
</html>
